<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>S-Box Dual Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Roboto', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 30px 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .header { text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 3px solid #667eea; }
        .header h2 { font-size: 32px; color: #2c3e50; margin-bottom: 5px; }
        
        .split-container { display: flex; flex-wrap: wrap; gap: 30px; align-items: flex-start; margin-bottom: 50px; }
        .column { flex: 1; min-width: 320px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 30px; border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .column:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(102, 126, 234, 0.2); }
        
        h3 { margin-top: 0; margin-bottom: 20px; color: #2c3e50; border-left: 5px solid #667eea; padding-left: 15px; font-size: 18px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #34495e; font-size: 13px; }
        
        input[type="file"], input[type="text"] { width: 100%; padding: 12px 14px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; background: #fff; font-size: 13px; transition: border-color 0.3s; }
        input[type="file"]:hover, input[type="text"]:hover { border-color: #667eea; }
        input[type="file"]:focus, input[type="text"]:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        
        .btn-sbox { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 14px; width: 100%; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; transition: transform 0.2s, box-shadow 0.2s; }
        .btn-enc { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 14px; width: 100%; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform: scale(1.02); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        button:active { transform: scale(0.98); }
        button:disabled { background: #bdc3c7; cursor: not-allowed; transform: scale(1); }

        .result-box { margin-top: 25px; padding: 20px; border-radius: 10px; border: none; background: rgba(255,255,255,0.8); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 12px; border: 1px solid #ecf0f1; text-align: left; }
        th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; }
        tr:nth-child(even) { background: #f8f9fa; }

        .crypto-text { font-family: 'Monaco', 'Courier New', monospace; font-size: 13px; background: #f5f7fa; padding: 12px; display: block; word-break: break-all; border-radius: 6px; border: 1px solid #ddd; margin-top: 8px; width: 100%; box-sizing: border-box; }
        textarea.crypto-text { min-height: 110px; resize: vertical; }
        .img-preview { max-width: 100%; border: 2px solid #ddd; border-radius: 8px; padding: 8px; background: #fafafa; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .team-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 12px; color: white; text-align: center; margin-top: 50px; }
        .team-section h3 { border-left: none; color: white; padding-left: 0; margin-bottom: 25px; }
        .team-members { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .team-member { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: transform 0.3s; }
        .team-member:hover { transform: translateY(-3px); background: rgba(255,255,255,0.15); }
        .team-member-name { font-weight: 600; font-size: 14px; }
        .team-member-num { font-size: 12px; opacity: 0.9; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>üî¨ S-Box Cryptographic Analyzer & Encryptor</h2>
    </div>

    <div class="split-container">
        <div class="column">
            <h3>üìä Analisis Properti S-Box</h3>
            <div class="form-group">
                <label>Pilih File Excel S-Box:</label>
                <input type="file" id="fileSbox" accept=".xlsx">
            </div>
            <button class="btn-sbox" onclick="runAnalysis()" id="btnA">RUN ANALISIS S-BOX</button>
            
            <div id="resA" style="display:none;" class="result-box">
                <p>Dimensi: <b id="sizeA"></b></p>
                <table>
                    <thead><tr><th>Parameter</th><th>Nilai</th><th>Ideal</th></tr></thead>
                    <tbody id="tableA"></tbody>
                </table>
            </div>
        </div>

        <div class="column">
            <h3>üîê Simulasi Enkripsi Teks</h3>
            <div class="form-group">
                <label>Input Teks:</label>
                <input type="text" id="plainText" placeholder="Contoh: Text123">
            </div>
            <div class="form-group">
                <label>Pilih File Excel S-Box (untuk Kunci):</label>
                <input type="file" id="fileEnc" accept=".xlsx">
            </div>
            <button class="btn-enc" onclick="runEncryption()" id="btnE">RUN ENKRIPSI TEKS</button>

            <div id="resE" style="display:none;" class="result-box">
                <p style="font-weight:bold; color:#7f8c8d; margin-bottom:5px;">Ciphertext (Hex):</p>
                <span class="crypto-text" id="outC"></span>
                <p style="font-weight:bold; color:#7f8c8d; margin-top:15px; margin-bottom:5px;">Decrypted Text:</p>
                <span class="crypto-text" id="outD" style="color:#27ae60;"></span>
            </div>
        </div>
    </div>

    <div style="margin-top: 30px; margin-bottom: 50px;">
        <div class="column" style="flex: none; max-width: 100%;">
            <h3>üñºÔ∏è Enkripsi / Dekripsi Gambar</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 14px; font-weight: 600;">Enkripsi</h4>
                    <div class="form-group">
                        <label>Key (contoh: text)</label>
                        <input type="text" id="keyImg" placeholder="text">
                    </div>
                    <div class="form-group">
                        <label>File Excel S-Box:</label>
                        <input type="file" id="fileSboxImg" accept=".xlsx">
                    </div>
                    <div class="form-group">
                        <label>File Gambar untuk Enkripsi:</label>
                        <input type="file" id="fileImg" accept="image/*">
                    </div>
                    <button class="btn-enc" onclick="runImageEncryption()" id="btnImgEnc">ENKRIPSI GAMBAR</button>

                    <div id="resImgEnc" style="display:none;" class="result-box">
                        <p style="font-weight:bold; color:#7f8c8d; margin-bottom:5px;">Cipher Image (PNG):</p>
                        <img id="cipherImgPreview" class="img-preview" alt="Preview hasil enkripsi" style="display:none;">
                        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                            <button type="button" class="btn-sbox" style="width:auto; padding:10px 16px;" id="btnDownloadCipher">Unduh Cipher (PNG)</button>
                            <small>Unduh file ini, lalu pakai di form dekripsi.</small>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 14px; font-weight: 600;">Dekripsi</h4>
                    <div class="form-group">
                        <label>Unggah file cipher (PNG) hasil enkripsi:</label>
                        <input type="file" id="cipherFile" accept="image/png" style="margin-top:10px;">
                    </div>
                    <div class="form-group">
                        <label>Key Dekripsi:</label>
                        <input type="text" id="keyImgDec" placeholder="text">
                    </div>
                    <button class="btn-sbox" onclick="runImageDecryption()" id="btnImgDec">DEKRIPSI GAMBAR</button>

                    <div id="resImgDec" style="display:none;" class="result-box">
                        <p style="font-weight:bold; color:#7f8c8d; margin-bottom:5px;">Hasil Dekripsi:</p>
                        <img id="imgPreview" class="img-preview" alt="Preview hasil dekripsi" style="display:none;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="team-section">
        <h3>üë• Anggota Kelompok</h3>
        <div class="team-members">
            <div class="team-member">
                <div class="team-member-num">1</div>
                <div class="team-member-name">Bilqis Winy Aqsa Dewi</div>
            </div>
            <div class="team-member">
                <div class="team-member-num">2</div>
                <div class="team-member-name">Nur Widhya Astuti</div>
            </div>
            <div class="team-member">
                <div class="team-member-num">3</div>
                <div class="team-member-name">Krisnawati Putri</div>
            </div>
            <div class="team-member">
                <div class="team-member-num">4</div>
                <div class="team-member-name">Luthfa Qubailatun Najwah</div>
            </div>
        </div>
    </div>
</div>

<script>
async function runAnalysis() {
    const file = document.getElementById('fileSbox').files[0];
    if(!file) return alert("Unggah file Excel dulu di kolom kiri!");

    const btn = document.getElementById('btnA');
    btn.disabled = true; btn.innerText = "Processing...";

    const fd = new FormData();
    fd.append('sbox_file', file);

    try {
        const r = await fetch('/analyze_only', { method: 'POST', body: fd });
        const d = await r.json();
        if(d.success) {
            document.getElementById('resA').style.display = 'block';
            document.getElementById('sizeA').innerText = d.size;
            const tb = document.getElementById('tableA');
            tb.innerHTML = '';
            for (const [k, v] of Object.entries(d.results)) {
                tb.innerHTML += `<tr><td><b>${k}</b></td><td>${v.value}</td><td>${v.ideal}</td></tr>`;
            }
        } else { alert(d.message); }
    } catch { alert("Server Error"); }
    btn.disabled = false; btn.innerText = "RUN ANALISIS S-BOX";
}

async function runEncryption() {
    const file = document.getElementById('fileEnc').files[0];
    const text = document.getElementById('plainText').value;
    if(!file || !text) return alert("Pilih file S-Box dan isi teks di kolom kanan!");

    const btn = document.getElementById('btnE');
    btn.disabled = true; btn.innerText = "Encrypting...";

    const fd = new FormData();
    fd.append('sbox_file', file);
    fd.append('plaintext', text);

    try {
        const r = await fetch('/encrypt_only', { method: 'POST', body: fd });
        const d = await r.json();
        if(d.success) {
            document.getElementById('resE').style.display = 'block';
            document.getElementById('outC').innerText = d.encryption;
            document.getElementById('outD').innerText = d.decryption;
        } else { alert(d.message); }
    } catch { alert("Server Error"); }
    btn.disabled = false; btn.innerText = "RUN ENKRIPSI TEKS";
}

async function runImageEncryption() {
    const sboxFile = document.getElementById('fileSboxImg').files[0];
    const imgFile = document.getElementById('fileImg').files[0];
    const key = document.getElementById('keyImg').value.trim();

    if(!sboxFile || !imgFile || !key) return alert("Lengkapi S-Box, gambar, dan key (contoh: test)");

    const btn = document.getElementById('btnImgEnc');
    btn.disabled = true; btn.innerText = "Encrypting...";

    const fd = new FormData();
    fd.append('sbox_file', sboxFile);
    fd.append('image_file', imgFile);
    fd.append('key', key);

    try {
        const r = await fetch('/encrypt_image', { method: 'POST', body: fd });
        const d = await r.json();
        if(d.success) {
            document.getElementById('resImgEnc').style.display = 'block';
            // Tampilkan preview gambar terenkripsi
            const imgPrev = document.getElementById('cipherImgPreview');
            imgPrev.src = `data:image/png;base64,${d.ciphertext}`;
            imgPrev.style.display = 'block';

            // Buat file gambar PNG agar bisa diunduh pengguna
            const blob = b64ToBlob(d.ciphertext, 'image/png');
            const url = URL.createObjectURL(blob);
            const btnDl = document.getElementById('btnDownloadCipher');
            btnDl.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                a.download = 'cipher.png';
                a.click();
            };
        } else { alert(d.message || 'Gagal enkripsi gambar'); }
    } catch (err) {
        alert('Server Error');
    }
    btn.disabled = false; btn.innerText = "ENKRIPSI GAMBAR";
}

async function runImageDecryption() {
    const cipherFile = document.getElementById('cipherFile').files[0];
    const key = document.getElementById('keyImgDec').value.trim();

    if(!cipherFile || !key) return alert("Lengkapi file cipher (PNG) dan key untuk dekripsi");

    const btn = document.getElementById('btnImgDec');
    btn.disabled = true; btn.innerText = "Decrypting...";

    const fd = new FormData();
    fd.append('cipher_file', cipherFile);
    fd.append('key', key);

    try {
        const r = await fetch('/decrypt_image', { method: 'POST', body: fd });
        const d = await r.json();
        if(d.success) {
            document.getElementById('resImgDec').style.display = 'block';
            if(d.mime && d.mime.startsWith('image/')) {
                document.getElementById('imgPreview').src = `data:${d.mime};base64,${d.plaintext}`;
                document.getElementById('imgPreview').style.display = 'block';
            } else {
                document.getElementById('imgPreview').style.display = 'none';
            }
        } else { alert(d.message || 'Gagal dekripsi gambar'); }
    } catch (err) {
        alert('Server Error');
    }
    btn.disabled = false; btn.innerText = "DEKRIPSI GAMBAR";
}

function b64ToBlob(b64Data, contentType='application/octet-stream') {
    const byteCharacters = atob(b64Data);
    const byteArrays = [];
    const sliceSize = 1024;
    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
        }
        byteArrays.push(new Uint8Array(byteNumbers));
    }
    return new Blob(byteArrays, { type: contentType });
}
</script>
</body>
</html>